CREATE DATABASE QLKS23
USE QLKS23

--TẠO BẢNG NHÂN VIÊN
CREATE TABLE NHANVIEN(
MANHANVIEN CHAR(10) NOT NULL PRIMARY KEY,
MATKHAU VARCHAR(20) NOT NULL,
HOTEN NVARCHAR(100) NOT NULL,
NGAYSINH DATE NOT NULL,
GIOITINH BIT NOT NULL ,
DIACHI NVARCHAR(100) NOT NULL,
SODIENTHOAI VARCHAR(20),
NGAYVAOLAM DATE NOT NULL,
);

INSERT INTO NHANVIEN
VALUES 
('NV01','123456',N'Nguyễn Thị Nụ','10/11/2000',1,N'Đống Đa-Hà Nội','0973287666','11/9/2020'),
('NV02','123456',N'Trần Văn Sang','1/1/2000',0,N'Thanh Trì-Hà Nội','0972873536','11/11/2020'),
('NV03','123456',N'Trần Tuấn Anh','1/20/2001',0,N'Hoàn Kiếm-Hà Nội','0273347611','11/1/2021'),
('NV04','123456',N'Nguyễn Thế Anh','3/2/1999',0,N'Nam Từ Liêm- Hà Nội','0273287666','11/2/2021'),
('NV05','123456',N'Lê Thị Thúy','1/2/2001',1,N'Cầu Giấy- Hà Nội','0973287999','11/12/2021');


--TẠO BẢNG KHACHHANG
CREATE TABLE KHACHHANG(
MAKHACH CHAR(10) NOT NULL PRIMARY KEY,
HOTEN NVARCHAR(100) NOT NULL,
GIOITINH BIT,
DIACHI NVARCHAR(50),
CMND CHAR(12),
DIENTHOAI VARCHAR(10),
);

INSERT INTO KHACHHANG
VALUES
('K01',N'Lê Đức Sơn',1,N'Đà Nẵng','030301009999','0987654678'),
('K02',N'Nguyễn Văn Túy ',0,N'Đà Lạt','0303010000','0987654888'),
('K03',N'Nguyễn Thị Lê ',0,N'Đà Lạt','0303010232','0987652412'),
('K04',N'Nguyễn Thị Thúy An ',0,N'Đà Lạt','0303010099','0987654982'),
('K05',N'Trần Gia Khánh ',0,N'Đà Lạt','0303010988','0987654763'),
('K06',N'Lò Văn Hóa ',0,N'Đà Lạt','0303010123','0987654128'),
('K07',N'Vũ Toàn',0,N'Đà Lạt','0303010045','0987654123');

--TẠO BẢNG THIETBI
CREATE TABLE THIETBI
(
MATHIETBI CHAR(10) NOT NULL PRIMARY KEY,
TENTHIETBI NVARCHAR(50) NOT NULL,
DVT NVARCHAR(10),
GIATIEN MONEY NOT NULL,
);

INSERT INTO THIETBI
VALUES
('MTB01',N'Điều hòa',N'chiếc',400),
('MTB02',N'Tivi',N'chiếc',300),
('MTB03',N'Giường',N'chiếc',100),
('MTB04',N'Máy chơi game',N'chiếc',10),
('MTB05',N'Bình nóng lạnh',N'chiếc',500),
('MTB06',N'Đèn điện',N'chiếc',10),
('MTB07',N'Bàn',N'chiếc',20),
('MTB08',N'Ghế',N'chiếc',10);


-- TẠO BẢNG LOAIPHONG
CREATE TABLE LOAIPHONG(
MALOAIPHONG CHAR(10) NOT NULL PRIMARY KEY,
LOAIPHONG NVARCHAR(50) NOT NULL,
GIATIEN MONEY NOT NULL,
);
INSERT INTO LOAIPHONG
VALUES 
('MLP01',N'Phòng vip',50),
('MLP02',N'Phòng tầm trung',30),
('MLP03',N'Phòng thường',10);


--TẠO BẢNG PHONG
CREATE TABLE PHONG
(
MAPHONG CHAR(10) NOT NULL PRIMARY KEY,
MALOAIPHONG CHAR(10) NOT NULL,
TINHTRANG BIT,
CONSTRAINT KN_DMPHONG FOREIGN KEY (MALOAIPHONG) REFERENCES LOAIPHONG(MALOAIPHONG),
);
INSERT INTO PHONG
VALUES
('MP01','MLP01',1),
('MP02','MLP01',1),
('MP03','MLP01',1),
('MP04','MLP01',1),
('MP05','MLP01',1),
('MP06','MLP02',1),
('MP07','MLP02',1),
('MP08','MLP02',1),
('MP09','MLP02',1),
('MP10','MLP02',1),
('MP11','MLP03',1),
('MP12','MLP03',1),
('MP13','MLP03',1),
('MP14','MLP03',1),
('MP15','MLP03',0),
('MP17','MLP03',0),
('MP18','MLP03',0),
('MP19','MLP03',0),
('MP20','MLP03',0),
('MP21','MLP03',0),
('MP22','MLP03',0),
('MP23','MLP03',0),
('MP24','MLP03',0);


--TẠO BẢNG THIETBI_PHONG
CREATE TABLE THIETBI_PHONG
(
MAPHONG CHAR(10) NOT NULL,
MATHIETBI CHAR(10) NOT NULL,
SOLUONG INT NOT NULL,
CONSTRAINT KC_THIETBI_PHONG PRIMARY KEY (MAPHONG,MATHIETBI),
CONSTRAINT KN_THIETBI_PHONG_MALOAIPHONG FOREIGN KEY (MAPHONG) REFERENCES PHONG(MAPHONG),
CONSTRAINT KN_THIETBI_PHONG_MATHIETBI FOREIGN KEY (MATHIETBI) REFERENCES THIETBI(MATHIETBI),
);

INSERT INTO THIETBI_PHONG
VALUES
('MP01','MTB01',2),
('MP01','MTB02',1),
('MP01','MTB03',1),
('MP01','MTB04',1),
('MP02','MTB05',1),
('MP02','MTB01',1),
('MP02','MTB02',1),
('MP02','MTB03',1),
('MP02','MTB06',1),
('MP03','MTB01',2),
('MP03','MTB03',1),
('MP03','MTB04',2),
('MP03','MTB05',1),
('MP03','MTB06',2),
('MP03','MTB07',1);


--TẠO BẢNG HÓA ĐƠN THUÊ PHÒNG
CREATE TABLE HDTHUEPHONG (
SHDTHUEPHONG NUMERIC IDENTITY(1,1) PRIMARY KEY,
MANHANVIEN CHAR(10) NOT NULL,
MAKHACH CHAR(10) NOT NULL,
MAPHONG CHAR(10) NOT NULL,
NGAYTHUE DATE NOT NULL,
NGAYTRA DATE,
CONSTRAINT KN_THUEPHONG_MANHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN),
CONSTRAINT KN_THUEPHONG_MAKHACH FOREIGN KEY (MAKHACH) REFERENCES KHACHHANG(MAKHACH),
CONSTRAINT KN_THUEPHONG_MAPHONG FOREIGN KEY (MAPHONG) REFERENCES PHONG(MAPHONG),
);

INSERT INTO HDTHUEPHONG(MANHANVIEN,MAKHACH, MAPHONG, NGAYTHUE,NGAYTRA)
VALUES
('NV01','K01','MP01','10/12/2021','1/1/2022'),
('NV02','K02','MP02','11/24/2021','1/9/2022'),
('NV03','K03','MP03','11/24/2021','11/1/2022'),
('NV04','K04','MP04','11/25/2021','1/2/2022'),
('NV03','K05','MP05','11/26/2021','12/26/2021'),
('NV02','K06','MP06','12/22/2021','1/1/2022'),
('NV01','K07','MP07','12/23/2021','1/23/2022'),
('NV01','K01','MP08','12/23/2021','1/23/2022'),
('NV04','K03','MP09','12/23/2021','1/23/2022'),
('NV01','K03','MP10','12/24/2021','1/24/2022'),
('NV02','K04','MP11','12/24/2021','1/24/2022'),
('NV03','K04','MP12','12/25/2021','1/25/2022'),
('NV04','K05','MP13','12/25/2021','1/25/2022'),
('NV05','K01','MP14','12/26/2021','1/26/2022');



--TẠO BẢNG HDTHANHTOANPHONG
CREATE TABLE HDTHANHTOANPHONG
(
SHDTHANHTOAN NUMERIC IDENTITY(1,1) PRIMARY KEY,
SHDTHUEPHONG NUMERIC  NOT NULL,
MANHANVIEN CHAR(10) NOT NULL,
NGAYTHANHTOAN DATE NOT NULL,
TIENPHONG MONEY NOT NULL,
CONSTRAINT KN_HDTHANHTOANPHONG_SHDTHUEPHONG FOREIGN KEY (SHDTHUEPHONG) REFERENCES HDTHUEPHONG(SHDTHUEPHONG),
CONSTRAINT KN_HDTHANHTOANPHONG_MANHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN),
);

INSERT INTO HDTHANHTOANPHONG(SHDTHUEPHONG, MANHANVIEN,NGAYTHANHTOAN, TIENPHONG)
VALUES
(1, 'NV01','1/1/2022',200),
(2, 'NV02','1/9/2022',200),
(3, 'NV03','11/1/2022',200),
(4, 'NV04','1/2/2022',200),
(6, 'NV01','1/1/2022',200);

-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-17 21h43

--1 TẠO THỦ TỤC QUẢN LÝ NHÂN VIÊN CHO PHÉP THÊM, SỬA, XÓA NHÂN VIÊN
DROP PROC IF EXISTS SP_QLNV
GO
CREATE PROC SP_QLNV @action INT, @MSNV CHAR(10), @HOTENNV NVARCHAR(100), @MatKhau CHAR(20), @NGAYSINHNV DATE, @GIOITINHNV BIT, @DIACHINV NVARCHAR(100), @DIENTHOAINV VARCHAR(20), @NGAYVAOLAM DATE
AS
BEGIN
    IF(@action = 1)
    BEGIN
        INSERT INTO NHANVIEN VALUES(@MSNV, @MatKhau, @HOTENNV, @NGAYSINHNV, @GIOITINHNV, @DIACHINV, @DIENTHOAINV, @NGAYVAOLAM)
    END
    ELSE IF(@action = 2)
    BEGIN
        UPDATE NHANVIEN SET 
		MANHANVIEN = @MSNV, 
		MATKHAU = @MatKhau, 
		HOTEN = @HOTENNV, 
		NGAYSINH = @NGAYSINHNV, 
		GIOITINH = @GIOITINHNV, 
		DIACHI = @DIACHINV, 
		SODIENTHOAI = @DIENTHOAINV, 
		NGAYVAOLAM = @NGAYVAOLAM
		WHERE MANHANVIEN = @MSNV
    END
    ELSE
    BEGIN
        DELETE NHANVIEN WHERE MANHANVIEN = @MSNV
    END
END
GO

--LỰA CHỌN 1:THÊM
EXEC SP_QLNV  1,'NV06', '123',N'Lương Hy', '2001-02-22',0,N'Thái Bình','09123456789','2022-01-14'
GO

--LỰA CHỌN 2: SỬA
EXEC SP_QLNV  1,'NV06', '123',N'Lương Hy', '2001-02-22',0,N'Hà Nội','09123456789','2022-01-14'
GO

--LỰA CHỌN 3: XÓA
EXEC SP_QLNV  3,'NV06', '123',N'Lương Hy', '2001-02-22',0,N'Hà Nội','09123456789','2022-01-14'
GO


SELECT * FROM NHANVIEN
-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-17 21h55

--2 QUẢN LÝ THIẾT BỊ PHÒNG

DROP PROC IF EXISTS SP_THIETBI_PHONG
GO
CREATE PROC SP_THIETBI_PHONG (@action INT, @MAPHONG CHAR(10), @MATHIETBI CHAR(10), @SOLUONG INT) AS
BEGIN
IF (@action = 1)
    BEGIN
        INSERT THIETBI_PHONG VALUES (@MAPHONG, @MATHIETBI, @SOLUONG);
    END
ELSE IF (@action = 2)
    BEGIN
        UPDATE THIETBI_PHONG SET SOLUONG = @SOLUONG WHERE MAPHONG = @MAPHONG AND MATHIETBI = @MATHIETBI;
        --UPDATE THIETBI_PHONG SET SOLUONG = 1 WHERE MALOAIPHONG = 'MLP01' AND MATHIETBI = 'MTB02'
    END 
ELSE 
    BEGIN
        DELETE THIETBI_PHONG WHERE MAPHONG = @MAPHONG AND MATHIETBI = @MATHIETBI;
    END
END

-------------------------------------------------------------------------------------------
--THÊM
EXEC SP_THIETBI_PHONG 1, 'MP01', 'MTB08',3
SELECT * FROM THIETBI_PHONG
--SỬA
EXEC sp_ins_THIETBI_PHONG 2, 'MLP04', 'MTB08',3
SELECT * FROM THIETBI_PHONG
--XÓA
EXEC sp_ins_THIETBI_PHONG 3, 'MLP03', 'MTB08',10

-----------------------------------------------
-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-17 22h15
--3 THỦ TỤC QUẢN LÝ THIẾT BỊ CHO PHÉP THÊM, SỬA XÓA THÔNG TIN THIẾT BỊ

DROP PROC IF EXISTS SP_THIETBI
GO

CREATE PROC SP_THIETBI 
    @action INT, 
    @MATHIETBI CHAR(10), 
    @TENTHIETBI NVARCHAR(50), 
    @DVT NVARCHAR(10), 
    @GIATIEN MONEY
AS
BEGIN
    IF(@action = 1)
    BEGIN
        INSERT INTO THIETBI (MATHIETBI, TENTHIETBI, DVT, GIATIEN) 
        VALUES (@MATHIETBI, @TENTHIETBI, @DVT, @GIATIEN)
    END
    ELSE IF(@action = 2)
    BEGIN
        UPDATE THIETBI 
        SET TENTHIETBI = @TENTHIETBI, DVT = @DVT, GIATIEN = @GIATIEN
        WHERE MATHIETBI = @MATHIETBI
    END
    ELSE
    BEGIN
        DELETE FROM THIETBI 
        WHERE MATHIETBI = @MATHIETBI
    END
END
GO
--thêm
EXEC SP_THIETBI 1, 'TB001', N'Điều hòa', N'Cái', 100.00;

-- sửa 
EXEC SP_THIETBI 2, 'TB001', N'Điều hòa', N'Cái', 120.00;

--xóa 
EXEC SP_THIETBI 3, 'TB001', NULL, NULL, NULL;

-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-17 22h30
--4 THỦ TỤC QUẢN LÝ KHÁCH HÀNG CHO PHÉP THÊM, SỬA, XÓA THÔNG TIN KHÁCH HÀNG

DROP PROC IF EXISTS SP_QLKH
GO

CREATE PROC SP_QLKH 
    @action INT, 
    @MAKHACH CHAR(10), 
    @HOTEN NVARCHAR(100), 
    @GIOITINH BIT, 
    @DIACHI NVARCHAR(50), 
    @CMND CHAR(12), 
    @DIENTHOAI VARCHAR(10)
AS
BEGIN
    IF(@action = 1)
    BEGIN
        INSERT INTO KHACHHANG 
        VALUES (@MAKHACH, @HOTEN, @GIOITINH, @DIACHI, @CMND, @DIENTHOAI)
    END
    ELSE IF(@action = 2)
    BEGIN
        UPDATE KHACHHANG 
        SET HOTEN = @HOTEN, GIOITINH = @GIOITINH, DIACHI = @DIACHI, CMND = @CMND, DIENTHOAI = @DIENTHOAI 
        WHERE MAKHACH = @MAKHACH
    END
    ELSE
    BEGIN
        DELETE FROM KHACHHANG 
        WHERE MAKHACH = @MAKHACH
    END
END
GO

--THÊM
EXEC SP_QLKH 1, 'KH020', N'Nguyễn Thế Lập', 1, ' Vũ Quán, Tân Lập, Hà Nội', '030301002342', '0987654323'

--sửa
EXEC SP_QLKH 2, 'KH020', N'Nguyễn Thế Anh', 1, ' Vũ Quán, Tân Lập, Hà Nội', '030301002342', '0987654323'

--xóa
EXEC SP_QLKH 3, 'KH020', NULL, NULL, NULL, NULL, NULL
-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-17 22h35
--5 THỦ TỤC QUẢN LÝ LOẠI PHÒNG CHO PHÉP THÊM SỬA XÓA LOẠI PHÒNG


DROP PROC IF EXISTS SP_LOAIPHONG
GO

CREATE PROC SP_LOAIPHONG 
    @action INT, 
    @MALOAIPHONG CHAR(10), 
    @LOAIPHONG NVARCHAR(50), 
    @GIATIEN MONEY
AS
BEGIN
    IF(@action = 1)
    BEGIN
        INSERT INTO LOAIPHONG (MALOAIPHONG, LOAIPHONG, GIATIEN) 
        VALUES (@MALOAIPHONG, @LOAIPHONG, @GIATIEN)
    END
    ELSE IF(@action = 2)
    BEGIN
        UPDATE LOAIPHONG 
        SET LOAIPHONG = @LOAIPHONG, GIATIEN = @GIATIEN
        WHERE MALOAIPHONG = @MALOAIPHONG
    END
    ELSE
    BEGIN
        DELETE FROM LOAIPHONG 
        WHERE MALOAIPHONG = @MALOAIPHONG
    END
END
GO

--THÊM 
EXEC SP_LOAIPHONG 1, 'LP001', N'Phòng Deluxe', 100
--SỬA
EXEC SP_LOAIPHONG 2, 'LP001', N'Phòng Superior', 120
--XÓA
EXEC SP_LOAIPHONG 3, 'LP001', NULL, NULL

-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-18 20h40
--6 THỦ TỤC QUẢN LÝ PHÒNG CHO PHÉP THÊM, SỬA , XÓA THÔNG TIN PHÒNG

DROP PROC IF EXISTS SP_PHONG
GO

CREATE PROC SP_PHONG 
    @action INT,
    @MAPHONG CHAR(10),
    @MALOAIPHONG CHAR(10),
    @TINHTRANG BIT
AS
BEGIN
    IF (@action = 1)
    BEGIN
        INSERT INTO PHONG (MAPHONG, MALOAIPHONG, TINHTRANG)
        VALUES (@MAPHONG, @MALOAIPHONG, @TINHTRANG)
    END
    ELSE IF (@action = 2)
    BEGIN
        UPDATE PHONG
        SET MALOAIPHONG = @MALOAIPHONG, TINHTRANG = @TINHTRANG
        WHERE MAPHONG = @MAPHONG
    END
    ELSE
    BEGIN
        DELETE FROM PHONG
        WHERE MAPHONG = @MAPHONG
    END
END
GO
-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-18 20h50
-- 7 THỦ TỤC QUẢN LÝ SỬ DỤNG THIẾT BỊ PHÒNG THÊM, SỬA, XÓA 

DROP PROCEDURE IF EXISTS SP_THIETBI_PHONG
GO

CREATE PROCEDURE SP_THIETBI_PHONG 
    @action INT,
    @MAPHONG CHAR(10),
    @MATHIETBI CHAR(10),
    @SOLUONG INT
AS
BEGIN
    IF (@action = 1)
    BEGIN
        INSERT INTO THIETBI_PHONG (MAPHONG, MATHIETBI, SOLUONG)
        VALUES (@MAPHONG, @MATHIETBI, @SOLUONG)
    END
    ELSE IF (@action = 2)
    BEGIN
        UPDATE THIETBI_PHONG
        SET SOLUONG = @SOLUONG
        WHERE MAPHONG = @MAPHONG AND MATHIETBI = @MATHIETBI
    END
    ELSE
    BEGIN
        DELETE FROM THIETBI_PHONG
        WHERE MAPHONG = @MAPHONG AND MATHIETBI = @MATHIETBI
    END
END
GO	
-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-18 21H10
--8 THỦ TỤC QUẢN LÝ HÓA ĐƠN THUÊ PHÒNG CHO PHÉP THÊM, CẬP NHẬT THÔNG TIN HÓA ĐƠN THUE PHONG

DROP PROCEDURE IF EXISTS SP_HDTHUEPHONG
GO


CREATE PROCEDURE SP_HDTHUEPHONG 
    @action INT,
    @SHDTHUEPHONG NUMERIC = NULL OUTPUT,
    @MANHANVIEN CHAR(10),
    @MAKHACH CHAR(10),
    @MAPHONG CHAR(10),
    @NGAYTHUE DATE,
    @NGAYTRA DATE = NULL
AS
BEGIN
    IF (@action = 1)
    BEGIN
        INSERT INTO HDTHUEPHONG (MANHANVIEN, MAKHACH, MAPHONG, NGAYTHUE, NGAYTRA)
                    VALUES (@MANHANVIEN, @MAKHACH, @MAPHONG, @NGAYTHUE, @NGAYTRA);
        SET @SHDTHUEPHONG = SCOPE_IDENTITY();
    END
    ELSE IF (@action = 2)
    BEGIN
        UPDATE HDTHUEPHONG
        SET MANHANVIEN = @MANHANVIEN,
            MAKHACH = @MAKHACH,
            MAPHONG = @MAPHONG,
            NGAYTHUE = @NGAYTHUE,
            NGAYTRA = @NGAYTRA
        WHERE SHDTHUEPHONG = @SHDTHUEPHONG;
    END
END
GO
-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-1821h20
--9 THỦ TỤC QUẢN LÝ HÓA ĐƠN THANH TOÁN CHO PHÉP THÊM, CẬP NHẬT THÔNG TIN HÓA ĐƠN THANH TOÁN
DROP PROCEDURE IF EXISTS SP_HDTHANHTOANPHONG
GO

CREATE PROCEDURE SP_HDTHANHTOANPHONG 
    @action INT,
    @SHDTHANHTOAN NUMERIC = NULL OUTPUT,
    @SHDTHUEPHONG NUMERIC,
    @MANHANVIEN CHAR(10),
    @NGAYTHANHTOAN DATE,
    @TIENPHONG MONEY
AS
BEGIN
    IF (@action = 1)
    BEGIN
        INSERT INTO HDTHANHTOANPHONG (SHDTHUEPHONG, MANHANVIEN, NGAYTHANHTOAN, TIENPHONG)
             VALUES (@SHDTHUEPHONG, @MANHANVIEN, @NGAYTHANHTOAN, @TIENPHONG);
        SET @SHDTHANHTOAN = SCOPE_IDENTITY();
    END
    ELSE IF (@action = 2)
    BEGIN
        UPDATE HDTHANHTOANPHONG
        SET SHDTHUEPHONG = @SHDTHUEPHONG,
            MANHANVIEN = @MANHANVIEN,
            NGAYTHANHTOAN = @NGAYTHANHTOAN,
            TIENPHONG = @TIENPHONG
        WHERE SHDTHANHTOAN = @SHDTHANHTOAN;
    END
END
GO
-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-18 21h40
-- THỦ TỤC THỐNG KÊ BÁO CÁO: TÍNH DOANH THU THEO THÁNG VỚI THÁNG VÀ NĂM LÀ BIẾN ĐẦU VÀO
CREATE PROCEDURE SP_TINH_DOANH_THU
    @THANG INT,
    @NAM INT,
    @DOANH_THU MONEY OUTPUT
AS
BEGIN
    SET @DOANH_THU = (
        SELECT SUM(TIENPHONG) AS DOANH_THU
        FROM HDTHANHTOANPHONG
        WHERE MONTH(NGAYTHANHTOAN) = @THANG AND YEAR(NGAYTHANHTOAN) = @NAM
    );

    IF @DOANH_THU IS NULL
        SET @DOANH_THU = 0;
END

--THỰC THI
DECLARE @TONG_DOANH_THU MONEY;
EXEC SP_TINH_DOANH_THU @THANG = 1, @NAM = 2022, @DOANH_THU = @TONG_DOANH_THU OUTPUT;
SELECT @TONG_DOANH_THU AS [DOANH_THU_THEO_THANG_1_NAM_2022];

-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-17 18H50
-- THỦ TỤC BÁO CÁO HIỂN THỊ TÌNH TRẠNG CÁC PHÒNG HIỆN CÓ CỦA KHÁCH SẠN
CREATE PROCEDURE SP_BAOCAO_TINHTRANG_PHONG
AS
BEGIN
    SELECT P.MAPHONG, 
            CASE 
                WHEN T.SHDTHUEPHONG IS NOT NULL AND T.NGAYTRA IS NULL THEN N'Đang được thuê'
                WHEN T.SHDTHUEPHONG IS NOT NULL AND T.NGAYTRA IS NOT NULL THEN N'Đã trả phòng'
                ELSE N'Chưa được thuê' 
            END AS TINH_TRANG
    FROM PHONG P
    LEFT JOIN HDTHUEPHONG T ON P.MAPHONG = T.MAPHONG;
END

--THỰC THI
EXEC SP_BAOCAO_TINHTRANG_PHONG;

-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-18 21h50

--THỦ TỤC BÁO CÁO HIỂN THỊ SỐ LƯỢNG KHÁCH THUÊ PHÒNG THEO THÁNG. vỚI THÁNG VÀ NĂM LÀ BIẾN ĐẦU VÀO
CREATE PROCEDURE SP_BAOCAO_KHACH_THUE_PHONG
    @THANG INT,
    @NAM INT
AS
BEGIN
    SELECT MONTH(T.NGAYTHUE) AS THANG,
            YEAR(T.NGAYTHUE) AS NAM,
            COUNT(T.MAKHACH) AS SO_LUONG_KHACH
    FROM HDTHUEPHONG T
    WHERE MONTH(T.NGAYTHUE) = @THANG AND YEAR(T.NGAYTHUE) = @NAM
    GROUP BY MONTH(T.NGAYTHUE), YEAR(T.NGAYTHUE);
END

--THỰC THI
EXEC SP_BAOCAO_KHACH_THUE_PHONG @THANG = 12, @NAM = 2021;

-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-17 21H30
--Trigger cập nhật tình trạng phòng sau khi thuê phòng
DROP TRIGGER IF EXISTS trigger_tinhTrangPhong 
GO
CREATE TRIGGER trigger_tinhTrangPhong 
ON HDTHUEPHONG
AFTER INSERT
AS BEGIN
	DECLARE @msphong CHAR(20)
	SELECT @msphong = (select MAPHONG from inserted)
	UPDATE PHONG SET TINHTRANG = 1 WHERE PHONG.MAPHONG = @msphong
END
GO
--CHẠY THỬ
INSERT INTO HDTHUEPHONG VALUES('NV01','K01','MP01','2021-12-23','2022-01-23')

-- tác giả: Trần Quang Đức - K215480106140
-- ngày làm: 2024-06-18 22h00

---Tạo trigger để khi chèn dữ liệu vào bảng THUEPHONG, NGAYTRA không được bé hơn NGAYTHUE 
DROP TRIGGER IF EXISTS trigger_NgayTra 
GO
CREATE TRIGGER trigger_NgayTra
ON HDTHUEPHONG
FOR INSERT
AS BEGIN
	DECLARE @ngaythue DATE
	DECLARE @ngaytra DATE
	SET @ngaythue = (select NGAYTHUE from inserted)
	SET @ngaytra = (select NGAYTRA from inserted)
	IF (@ngaythue > @ngaytra) 
		BEGIN
			RAISERROR (N'Ngày trả không được trước ngày thuê',16,1)
			ROLLBACK TRANSACTION
		END
END
--Chạy thử:
INSERT INTO HDTHUEPHONG VALUES('NV01','K01','MP14','2021-12-23','2021-11-23')
